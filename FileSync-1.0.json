{
	"jpsType": "update",
	"jpsVersion": "0.3",
	"application": {
		"targetNodes": {
			"nodeGroup": "cp"
		},
		"id": "filesync",
		"name": "File Synchronization",
		"version": "1.0",
		"type": "php",
		"homepage": "http://docs.jelastic.com/file-synchronization",
		"logo": "https://raw.githubusercontent.com/JelasticJPS/FileSync/master/images/icon.png",
		"description": "<br><div style=\"margin:0 auto; text-align:center\"><img style=\"margin:0 auto\" src=\"https://raw.githubusercontent.com/JelasticJPS/FileSync/master/images/ilustration.png\"></div><br>Use the options below to:<ul style=\"list-style: inherit; margin-left: 3%\"><li>choose the required environment</li><li>specify Path to the folder you’d like to sync (otherwise, the whole webroot directory will be synchronized)</li><li>state the Delay (in seconds).</li></ul>",
		"settings": {
			"fields": [{
					"type": "radio-fieldset",
					"name": "optional",
					"default": "one_env",
					"values": {
						"one_env": {
							"en": "One env synchronization"
						},
						"two_envs": {
							"en": "Two envs synchronization"
						}
					},
					"showIf": {
						"one_env": [{
								"type": "string",
								"placeholder": "relative to ${SERVER_WEBROOT}",
								"name": "path",
								"caption": {
									"en": "Sync path",
									"ru": "Путь установки"
								},
								"required": false
							}, {
								"default": "10",
								"name": "delay",
								"caption": {
									"en": "Delay (seconds)",
									"ru": "Задержка синхронизации"
								},
								"type": "string",
								"required": false
							}
						],
						"two_envs": [{
								"type": "string",
								"placeholder": "relative to ${SERVER_WEBROOT}",
								"name": "path",
								"caption": {
									"en": "Sync path",
									"ru": "Путь установки"
								},
								"required": false
							}, {
								"default": "10",
								"name": "delay",
								"caption": {
									"en": "Delay (seconds)",
									"ru": "Задержка синхронизации"
								},
								"type": "string",
								"required": false
							}, {
								"type": "string",
								"name": "address",
								"caption": "IP address",
								"placeholder": "optional"
							}, {
								"type": "string",
								"name": "password",
								"caption": "Password",
								"placeholder": "optional"
							}
						]
					}
				}
			]
		},
		"onInstall": {
			"call": [
					"safeCustomPath",
					"installRsyncDaemon",
					"startLsyncDaemon"
			]
		},
		"onUninstall": {
			"call": "removeLsyncd"
		},
		"env": {
			"onBeforeDeploy": {
				"executeShellCommands": [{
						"nodeMission": "cp",
						"commands": [
								"killall -9 lsyncd 2>/dev/null 1>/dev/null",
								"killall -9 rsync 2>/dev/null 1>/dev/null"
						]
					}
				]
			},
			"onAfterDeploy": {
				"call": [
						"installRsyncDaemon",
						"startLsyncDaemon"
				]
			},
			"onAfterCloneNodes": {
				"call": [
						"installRsyncDaemon",
						"startLsyncDaemon"
				]
			},
			"onAfterRemoveNode": [{
					"call": [
							"installRsyncDaemon",
							"startLsyncDaemon"
					]
				}
			]
		},
		"procedures": [{
				"id": "removeLsyncd",
				"onCall": [{
						"executeShellCommands": [{
								"nodeMission": "cp",
								"commands": [
										"killall rsync 2>/dev/null 1>/dev/null",
										"killall lsyncd 2>/dev/null 1>/dev/null",
										"rm -rf /var/www/webroot/lsyncd 2>/dev/null 1>/dev/null",
										"crontab -l | sed \"/lsyncd/d\" | crontab -"
								]
							}
						]
					}
				]
			}, {
				"id": "safeCustomPath",
				"onCall": [{
						"executeShellCommands": [{
								"nodeMission": "cp",
								"commands": [
										"rm -rf /tmp/.lsyncd",
										"mkdir /tmp/.lsyncd",
										"echo '${settings.path}' > /tmp/.lsyncd/custom_path"
								]
							}
						]
					}
				]
			}, {
				"id": "installRsyncDaemon",
				"onCall": [{
						"executeScript": {
							"description": "Get compute nodes Ids and mirrors compute node's address for rsync",
							"type": "javascript",
							"script": "https://raw.githubusercontent.com/JelasticJPS/FileSync/master/scripts/installRsyncDaemon.js"
						}
					}
				]
			}, {
				"id": "installLsync",
				"onCall": [{
						"executeShellCommands": [{
								"nodeId": "${this.nodeId}",
								"commands": [
										"rm -rf ${SERVER_WEBROOT}/lsyncd"
								]
							}
						]
					}, {
						"createDirectory": [{
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd"
							}
						]
					}, {
						"upload": [{
								"nodeId": "${this.nodeId}",
								"destPath": "${SERVER_WEBROOT}/lsyncd/sync.tar",
								"sourcePath": "https://raw.githubusercontent.com/JelasticJPS/FileSync/master/dumps/sync2.tar.gz"
							}
						]
					}, {
						"executeShellCommands": [{
								"nodeId": "${this.nodeId}",
								"commands": [
										"tar -xf ${SERVER_WEBROOT}/lsyncd/sync.tar -C ${SERVER_WEBROOT}/lsyncd/",
										"CUSTOM_PATH=$(cat /tmp/.lsyncd/custom_path)",
										"[ $CUSTOM_PATH ] && [ ${CUSTOM_PATH:0:1} == \"/\" ] && CUSTOM_PATH=${CUSTOM_PATH:1}",
										"[ $CUSTOM_PATH ] && [ ${CUSTOM_PATH:${#CUSTOM_PATH}-1} == \"/\" ] && CUSTOM_PATH=$(echo ${CUSTOM_PATH::-1}) ",
										"[ $CUSTOM_PATH ] && CUSTOM_PATH=${CUSTOM_PATH}/ || CUSTOM_PATH=\"\" ",
										"sed -i \"s|{SERVER_WEBROOT}|${SERVER_WEBROOT}/${CUSTOM_PATH}|g\" ${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf",
										"sed -i \"s|{LSYNCD_TMP}|lsyncd_tmp/|g\" ${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf",
										"sed -i \"s|{DELAY}|${settings.delay}|g\" ${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf",
										"sed -i \"s|{SERVER_WEBROOT}|${SERVER_WEBROOT}/${CUSTOM_PATH}|g\" ${SERVER_WEBROOT}/lsyncd/etc/rsync.conf",
										"sed -i \"s|--temp-dir=/|--temp-dir=/lsyncd_tmp|g\" ${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf",
										"curl \"https://raw.githubusercontent.com/JelasticJPS/FileSync/master/scripts/checkROOTZDT.sh\" -o  ${SERVER_WEBROOT}/zdt.sh",
										"bash ${SERVER_WEBROOT}/zdt.sh ${SERVER_WEBROOT} 2>&1",
										"rm ${SERVER_WEBROOT}/zdt.sh",
										"rm -rf ${SERVER_WEBROOT}/${CUSTOM_PATH}lsyncd_tmp",
										"mkdir ${SERVER_WEBROOT}/${CUSTOM_PATH}lsyncd_tmp",
										"rm -rf /tmp/lsyncd_tmp",
										"ln -s /var/www/webroot/${CUSTOM_PATH}lsyncd_tmp/ /tmp/"
								]
							}
						]
					}, {
						"replaceInFile": [{
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf",
								"replacements": [{
										"pattern": "_MIRROR_SERVER_IP",
										"replacement": "${this.mirrorServerIp}"
									}, {
										"pattern": "_USER",
										"replacement": "admin"
									}, {
										"pattern": "_INSTALL_DIRECTORY",
										"replacement": "${SERVER_WEBROOT}/lsyncd"
									}, {
										"pattern": "name",
										"replacement": "varwwwwebroot"
									}
								]
							}, {
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd/etc/rsync.conf",
								"replacements": [{
										"pattern": "_NAME",
										"replacement": "varwwwwebroot"
									}, {
										"pattern": "_USER",
										"replacement": "admin"
									}, {
										"pattern": "_INSTALL_DIRECTORY",
										"replacement": "${SERVER_WEBROOT}/lsyncd"
									}
								]
							}, {
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd/etc/rsyncd.pass",
								"replacements": [{
										"pattern": "_PASSWORD",
										"replacement": "${user.appPassword}"
									}
								]
							}, {
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd/etc/rsyncd.secrets",
								"replacements": [{
										"pattern": "_PASSWORD",
										"replacement": "${user.appPassword}"
									}, {
										"pattern": "_USER",
										"replacement": "admin"
									}
								]
							}, {
								"nodeId": "${this.nodeId}",
								"path": "${SERVER_WEBROOT}/lsyncd/init.sh",
								"replacements": [{
										"pattern": "_INSTALL_DIRECTORY",
										"replacement": "${SERVER_WEBROOT}/lsyncd/"
									}
								]
							}
						]
					}, {
						"executeShellCommands": [{
								"nodeId": "${this.nodeId}",
								"commands": [
										"cd ${SERVER_WEBROOT}/lsyncd/",
										"chmod 600 etc/rsyncd.pass",
										"chmod 600 etc/rsyncd.secrets",
										"chmod 755 usr/bin/lsyncd",
										"killall -9 lsyncd 2>/dev/null 1>/dev/null",
										"killall -9 rsync 2>/dev/null 1>/dev/null",
										"/usr/bin/rsync --daemon --config=${SERVER_WEBROOT}/lsyncd/etc/rsync.conf --port=7755 &>>${SERVER_WEBROOT}/lsyncd/var/log/rsyncd_start.log & echo $! > ${SERVER_WEBROOT}/lsyncd/bg.pid"
								]
							}, {
								"nodeId": "${this.nodeId}",
								"commands": [
										"curl -fsS \"https://raw.githubusercontent.com/JelasticJPS/FileSync/master/scripts/twoEnvs.sh\" -o ${SERVER_WEBROOT}/addSecondEnv.sh",
										"bash -x ${SERVER_WEBROOT}/addSecondEnv.sh \"${settings.address}\" > /tmp/.lsyncd/2Env.log",
										"echo \"${settings.password}\" >${SERVER_WEBROOT}/lsyncd/etc/rsyncd.pass",
										"echo \"admin:${settings.password}\" > ${SERVER_WEBROOT}/lsyncd/etc/rsyncd.secrets",
										"rm -f ${SERVER_WEBROOT}/addSecondEnv.sh"
								]
							}
						]
					}
				]
			}, {
				"id": "startLsyncDaemon",
				"onCall": [{
						"executeShellCommands": [{
								"nodeMission": "cp",
								"commands": [
										"${SERVER_WEBROOT}/lsyncd/usr/bin/lsyncd ${SERVER_WEBROOT}/lsyncd/etc/lsyncd.conf &>>${SERVER_WEBROOT}/lsyncd/var/log/lsyncd_start.log"
								]
							}, {
								"nodeMission": "cp",
								"commands": [
										"(crontab -l 2>/dev/null | grep -q init.sh ||  {  crontab -l 2>/dev/null | { cat; echo \"*/3 * * * *  /bin/bash /var/www/webroot/lsyncd/init.sh check\"; } | crontab - ; } ; )"
								]
							}
						]
					}
				]
			}
		],
		"success": {
			"text": {
				"en": "Lsyncd is installed on your environment.<br>You can find config files and logs at the webroot directory.",
				"ru": "Lsyncd установлен на ваше окружение.<br> Вы можете найти конфигурационные фалы и лог файлы в директории webroot."
			}
		}
	}
}
